
# C++内存结构

内存***从高地址到低地址***分别是：
- 栈stack
	- 保存函数局部变量、参数以及返回值
	- 从高到低生长
- 堆heap
	- 动态内存分配的变量
	- 从低到高生长
- bss段
	- 用于表示程序中未初始化的全局变量和静态变量的段（section）或区域
	- 只包含全局和静态变量的名称、大小、类型等信息
	- 在程序加载时分配内存
	- 不会在可执行文件中占据空间，因为这些未初始化的变量会自动被置为0或空值
- data段
	- 全局/静态存储区
		- 存储全局和静态变量，生命周期和程序相同
	- 常量存储区
		- 存储字符串常量等常量，生命周期和程序相同 **存疑**
- 代码段text
	- 只读


## new和malloc的区别

- malloc是函数，new是运算符
- malloc仅分配内存，new还会调用构造函数
- malloc返回void*，需要强转类型，new直接返回对象类型指针
- malloc分配内存失败返回NULL，new会抛出异常，需要捕获
```C++[]
try { int *a = new int(); }
catch (bad_alloc) {}
```
- malloc需要指定分配大小，new自动计算
- new内部会先调用operator new分配空间，再调用placement new在指定的空间调用构造函数
- malloc可以和realloc等配套使用，new没有对应配合的函数
- realloc如果发现原地址有足够大空间可以继续分配则继续，不能则另找地方
- new\[]会在空间头部加一个int来存储数组长度，调用delete\[]时才知道要调用几次析构函数
- 所以new和delete要配套使用

## malloc算法

- 大概可分为隐藏头（hidden header）和位图（bitmap）两类
- 隐藏头是指存储在每个分配的内存块之前的额外信息
	- 这些信息通常用于跟踪内存块的大小、状态和其他元数据。例如，常见的隐藏头可能包括分配块的大小、分配状态、指向下一个块的指针等
- 位图通常是一个二进制数组，每个位代表一个内存块的分配状态
	- 通常，一个位图中的每个位对应于内存中的一个固定大小的块
	- 当内存块被分配时，相应的位被设置为已分配状态；释放时，设置为空闲状态
- **alloca**函数可以在栈上分配内存，可以编译器自动管理，太大会爆栈导致越界